name: CI/CD Pipeline

on:
  push:
    branches: ['**']  # All branches
  pull_request:
    branches: ['**']

# Cancel in-progress runs for same PR/branch (saves CI time)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =========================================================================
  # JOB 1: CODE QUALITY (Fast Feedback - ~1-2 min)
  # Runs on: All pushes and PRs
  # =========================================================================
  quality:
    name: Code Quality (pylint, black, mypy, bandit)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      # Install quality tools + project dependencies (needed for pylint imports)
      - name: Install quality tools
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r server/requirements.txt
          pip install pylint>=3.0.0 black>=24.0.0 mypy>=1.8.0 bandit>=1.7.0

      # Black: Code formatting check (fail-fast)
      - name: Check code formatting (black)
        run: |
          black --check --diff src/ tests/ server/src/ server/tests/

      # Pylint: Code quality (enforced threshold)
      - name: Lint with pylint (client)
        run: |
          pylint src/ --fail-under=8.0

      - name: Lint with pylint (server)
        run: |
          pylint server/src/ --fail-under=8.0

      # Mypy: Type checking (gradual enforcement)
      - name: Type check with mypy (client)
        run: |
          mypy src/ --ignore-missing-imports --check-untyped-defs
        continue-on-error: true  # Warning only for now

      - name: Type check with mypy (server)
        run: |
          mypy server/src/ --ignore-missing-imports --check-untyped-defs
        continue-on-error: true  # Warning only for now

      # Bandit: Security scanning
      - name: Security scan with bandit (client)
        run: |
          bandit -r src/ -f screen --severity-level medium -c pyproject.toml

      - name: Security scan with bandit (server)
        run: |
          bandit -r server/src/ -f screen --severity-level medium
        continue-on-error: true  # Server has different structure

  # =========================================================================
  # JOB 2: TESTS (Most Important - ~2-3 min)
  # Runs on: All pushes and PRs
  # =========================================================================
  tests:
    name: Tests & Coverage
    runs-on: windows-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      # Install ALL dependencies (testing requires full env)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -r server/requirements.txt

      # Run pytest with coverage threshold
      # Note: Coverage options in pyproject.toml (70% threshold, measures src/analysis only)
      - name: Run client tests with coverage
        run: |
          pytest tests/ -v --cov=src/analysis --cov-report=xml --cov-report=term --cov-fail-under=70
        env:
          PYTEST_TIMEOUT: 300

      - name: Run server tests
        run: |
          pytest server/tests/ -v
        env:
          PYTEST_TIMEOUT: 300
        continue-on-error: true  # Server tests may require database

      # Upload coverage to Codecov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: unittests
          name: codecov-leaguestats
          fail_ci_if_error: false  # Don't fail CI if Codecov has issues

      # Archive test results for debugging
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage.xml
            .coverage
          retention-days: 7

  # =========================================================================
  # JOB 3: PERFORMANCE BENCHMARKS (Optional - ~3-5 min)
  # Runs on: main branch only (not PRs to save time)
  # =========================================================================
  performance:
    name: Performance Benchmarks
    runs-on: windows-latest
    timeout-minutes: 15
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      # Run performance benchmarks (measure only, no pass/fail)
      - name: Run performance benchmarks
        run: |
          python -m pytest tests/ -v -k "benchmark" --benchmark-only --benchmark-json=benchmark.json
        continue-on-error: true

      # Save benchmark results as artifact
      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark.json
          retention-days: 30

  # =========================================================================
  # JOB 4: BUILD EXECUTABLE (Resource Intensive - ~5-8 min)
  # Runs on: main branch merges only
  # =========================================================================
  build:
    name: Build Windows Executable
    runs-on: windows-latest
    timeout-minutes: 20
    needs: [quality, tests]  # Only if quality + tests pass
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/inspiring-rhodes')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      # Build with PyInstaller
      - name: Build executable
        run: |
          python build_app.py

      # Verify build succeeded
      - name: Verify build and measure size
        run: |
          if (Test-Path "dist/LeagueStatsCoach.exe") {
            $size = (Get-Item "dist/LeagueStatsCoach.exe").Length / 1MB
            Write-Host "‚úÖ Build successful"
            Write-Host "üì¶ Executable size: $([math]::Round($size, 2)) MB"
            exit 0
          } else {
            Write-Host "‚ùå Build failed: executable not found"
            exit 1
          }
        shell: pwsh

  # =========================================================================
  # JOB 5: SUMMARY (Always runs - provides final status)
  # =========================================================================
  ci-status:
    name: CI Status Summary
    runs-on: ubuntu-latest
    needs: [quality, tests]
    if: always()

    steps:
      - name: Check CI status
        run: |
          if [ "${{ needs.quality.result }}" == "success" ] && [ "${{ needs.tests.result }}" == "success" ]; then
            echo "‚úÖ All required checks passed!"
            exit 0
          else
            echo "‚ùå Some checks failed:"
            echo "  - Quality: ${{ needs.quality.result }}"
            echo "  - Tests: ${{ needs.tests.result }}"
            exit 1
          fi
